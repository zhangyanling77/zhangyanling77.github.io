# 面试题收集

## 一、文件上传，实现分片上传、断点续传
### 前端部分（create-reac-app + antd + typescript)
* 创建项目
```bash
$ npx create-react-app my-upload --tempalte typescript
$ yarn add antd
$ cd my-upload
$ yarn start
```
高级配置可按照antd官方来进行配置，这里不做赘述。

* 修改App.tsx
```javascript
  import React, { Component } from 'react';
  import './App.less';
  import Upload from './Upload';

  class App extends Component {
    render() {
      return (
        <div className="App">
          <Upload />
        </div>
      );
    }
  }

  export default App;
```
* Upload.tsx
```javascript
  import React, { ChangeEvent, useState, useEffect } from 'react';
  import { Row, Col, Input, Button, Card, message } from 'antd';
  import { request } from './request';
  function Upload() {
      let [currentFile, setCurrentFile] = useState<File>();
      let [objectURL, setObjectURL] = useState<string>(''); // 做一个预览效果
      useEffect(() => {
          if (currentFile) {
              const reader = new FileReader();
              reader.addEventListener('load', () => setObjectURL(reader.result as string));
              reader.readAsDataURL(currentFile);
          }
      }, [currentFile]);
      function handleChange(event: ChangeEvent<HTMLInputElement>) {
          let file: File = event.target.files![0];
          console.log(file);
          setCurrentFile(file);
      }
      async function handleUpload() {
          if (!currentFile) {
              return message.error('你尚未选择文件');
          }
          if (!allowUpload(currentFile)) {
              return message.error('不支持此类文件的上传');
          }
          const formData = new FormData();
          formData.append('chunk', currentFile);//添加文件，字段名chunk
          formData.append('filename', currentFile.name);//dog.jpg
          let result = await request({
              url: '/upload',
              method: 'POST',
              data: formData
          });
          message.info('上传成功');
      }
      return (
          <Row>
              <Col span={12}>
                  <Input type="file" style={{ width: 300 }} onChange={handleChange} />
                  <Button type="primary" onClick={handleUpload} style={{ marginLeft: 10 }}>上传</Button>
              </Col>
              <Col span={12} style={{ padding: 20 }}>
                  {objectURL && <Card
                    hoverable
                    cover={<img alt="example" src={objectURL} />}
                  >
                    {currentFile && currentFile.name}
                  </Card>}
              </Col>
          </Row>
      )
  }
  function allowUpload(file: File) {
      let isValidFileType = ["image/jpeg", "image/png", "image/gif", "video/mp4"].includes(file.type);
      if (!isValidFileType) {
          message.error('不支持此类文件上传');
      }
      //文件大小的单位是字节  1024bytes=1k*1024=1M*1024=1G
      const isLessThan2G = file.size < 1024 * 1024 * 1024 * 2;
      if (!isLessThan2G) {
          message.error('上传的文件不能大于2G');
      }
      return isValidFileType && isLessThan2G;
  }

  export default Upload;
```
* request.tsx
```javascript
  interface OPTIONS {
    baseURL?: string;
    method: string;
    url: string;
    headers?: any;
    data: any;
  }
  export function request(options: OPTIONS): Promise<any> {
    let defaultOptions = {
        method: 'GET',
        baseURL: 'http://localhost:3000', // 服务器host
        headers: {},
        data: {},
    }
    options = { ...defaultOptions, ...options, headers: { ...defaultOptions.headers, ...(options.headers || {}) } };
    return new Promise(function (resolve: Function, reject: Function) {
        let xhr = new XMLHttpRequest();
        xhr.open(options.method, options.baseURL + options.url);
        for (let key in options.headers) {
            xhr.setRequestHeader(key, options.headers[key]);
        }
        xhr.responseType = 'json';
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4) {
                if (xhr.status === 200) {
                    resolve(xhr.response);
                } else {
                    reject(xhr.response);
                }
            }
        }
        xhr.send(options.data);
    });
  }
```

* 后端部分（express）
